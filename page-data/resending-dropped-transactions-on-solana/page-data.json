{"componentChunkName":"component---src-templates-blog-post-js","path":"/resending-dropped-transactions-on-solana/","result":{"data":{"site":{"siteMetadata":{"title":"Brian Friel","author":"Brian Friel"}},"markdownRemark":{"id":"4214bf22-4d70-5043-abdd-0ea936793e50","excerpt":"This article was originally published on The Solana Cookbook. Introduction On some occasions, a seemingly valid transaction may be dropped before it is included…","html":"<p><em>This article was originally published on <a href=\"https://solanacookbook.com/guides/retrying-transactions.html#retrying-transactions\">The Solana Cookbook</a>.</em></p>\n<h2>Introduction</h2>\n<p>On some occasions, a seemingly valid transaction may be dropped before it is included in a block. This most often occurs during periods of network congestion, when an RPC node fails to rebroadcast the transaction to the <a href=\"https://docs.solana.com/terminology#leader\">leader</a>. To an end-user, it may appear as if their transaction disappears entirely. While RPC nodes are equipped with a generic rebroadcasting algorithm, application developers are also capable of developing their own custom rebroadcasting logic.</p>\n<h2>The Journey of a Transaction</h2>\n<h3>How Clients Submit Transactions</h3>\n<p>In Solana, there is no concept of a mempool. All transactions, whether they are initiated programmatically or by an end-user, are efficiently routed to leaders so that they can be processed into a block. There are two main ways in which a transaction can be sent to leaders:</p>\n<ol>\n<li>By proxy via an RPC server and the <a href=\"https://docs.solana.com/developing/clients/jsonrpc-api#sendtransaction\">sendTransaction</a> JSON-RPC method</li>\n<li>Directly to leaders via a <a href=\"https://docs.rs/solana-client/1.7.3/solana_client/tpu_client/index.html\">TPU Client</a></li>\n</ol>\n<p>The vast majority of end-users will submit transactions via an RPC server. When a client submits a transaction, the receiving RPC node will in turn attempt to broadcast the transaction to both the current and next leaders. Until the transaction is processed by a leader, there is no record of the transaction outside of what the client and the relaying RPC nodes are aware of. In the case of a TPU client, rebroadcast and leader forwarding is handled entirely by the client software.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/c3a612dc41e73a10adf444aee60bce60/c7443/tx-journey.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 54.05405405405405%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAABkElEQVQoz32TS27UQBCGcxoOwB04BDeAbW4QsR0FwYpFIpHHkkhIZAcDiygRbIgSDWEB4pEBjzwOGeNH97gf9aFp28mMM6SkUj+q/fVfXeUVABHBi4Sxtfl5126LrcgSULu21pIkY/4kMVk6YTyOUUotnJsdbT0AW9CFSZco8UwyTXRZkfytUErjnOuolMbrvQDci/rcO3jA9nA/BJRWKD0N872PwtpLzeM3MM5rhJcWAOJALIiXa4XPfrzgbv8+va87YbMoC/KiDDdvHVpWdyc8euUYXnrAYYwLMRULn59POdusSD7UagNQO837dEBuyxtpj1IY/IYvsWBco9DN1Hiyn57jdcXxuiZ63QC7FRNk4cG7NnvDsihxYqkyIT6AqA/Z97mUy/Mjfu0/JP/Wr6HeXUG9F1zj9dpjKoPgKSPPYFPzaUMTH82lfHHY46R3h/jdWqiXczZ8+H+vK1sMhZOnU06fVIzezgFtPiI93cWk51yV7zZrwt6AiqAcgsnkurG7f4EsNO4Sp21+udGH/wAYvU7QRR3jiwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Transaction Journey\"\n        title=\"Transaction Journey\"\n        src=\"/static/c3a612dc41e73a10adf444aee60bce60/fcda8/tx-journey.png\"\n        srcset=\"/static/c3a612dc41e73a10adf444aee60bce60/12f09/tx-journey.png 148w,\n/static/c3a612dc41e73a10adf444aee60bce60/e4a3f/tx-journey.png 295w,\n/static/c3a612dc41e73a10adf444aee60bce60/fcda8/tx-journey.png 590w,\n/static/c3a612dc41e73a10adf444aee60bce60/efc66/tx-journey.png 885w,\n/static/c3a612dc41e73a10adf444aee60bce60/c83ae/tx-journey.png 1180w,\n/static/c3a612dc41e73a10adf444aee60bce60/c7443/tx-journey.png 3488w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h3>How RPC Nodes Broadcast Transactions</h3>\n<p>After an RPC node receives a transaction via <code class=\"language-text\">sendTransaction</code>, it will convert the transaction into a <a href=\"https://en.wikipedia.org/wiki/User_Datagram_Protocol\">UDP</a> packet before forwarding it to the relevant leaders. UDP allows validators to quickly communicate with one another, but does not provide any guarantees regarding transaction delivery.</p>\n<p>Because Solana’s leader schedule is known in advance of every <a href=\"https://docs.solana.com/terminology#epoch\">epoch</a> (~2 days), an RPC node will broadcast its transaction directly to the current and next leaders. This is in contrast to other gossip protocols such as Ethereum that propagate transactions randomly and broadly across the entire network.  By default, RPC nodes will try to forward transactions to leaders every two seconds until either the transaction is finalized or the transaction’s blockhash expires (150 blocks or ~1 minute 19 seconds as of the time of this writing). If the outstanding rebroadcast queue size is greater than <a href=\"https://github.com/solana-labs/solana/blob/bfbbc53dac93b3a5c6be9b4b65f679fdb13e41d9/send-transaction-service/src/send_transaction_service.rs#L20\">10,000 transactions</a>, newly submitted transactions are dropped.  There are command-line <a href=\"https://github.com/solana-labs/solana/blob/bfbbc53dac93b3a5c6be9b4b65f679fdb13e41d9/validator/src/main.rs#L1172\">arguments</a> that RPC operators can adjust to change the default behavior of this retry logic.</p>\n<p>When an RPC node broadcasts a transaction, it will attempt to forward the transaction to a leader’s <a href=\"https://github.com/solana-labs/solana/blob/cd6f931223181d5a1d47cba64e857785a175a760/core/src/validator.rs#L867\">Transaction Processing Unit (TPU)</a>. The TPU processes transactions in five distinct phases:</p>\n<ul>\n<li><a href=\"https://github.com/solana-labs/solana/blob/cd6f931223181d5a1d47cba64e857785a175a760/core/src/fetch_stage.rs#L21\">Fetch Stage</a></li>\n<li><a href=\"https://github.com/solana-labs/solana/blob/cd6f931223181d5a1d47cba64e857785a175a760/core/src/tpu.rs#L91\">SigVerify Stage</a></li>\n<li><a href=\"https://github.com/solana-labs/solana/blob/cd6f931223181d5a1d47cba64e857785a175a760/core/src/banking_stage.rs#L249\">Banking Stage</a></li>\n<li><a href=\"https://github.com/solana-labs/solana/blob/cd6f931223181d5a1d47cba64e857785a175a760/poh/src/poh_service.rs\">Proof of History Service</a></li>\n<li><a href=\"https://github.com/solana-labs/solana/blob/cd6f931223181d5a1d47cba64e857785a175a760/core/src/tpu.rs#L136\">Broadcast Stage</a></li>\n</ul>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/2df9a40c7cc865c061c8256d0299fecf/2d912/tpu-jito-labs.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 59.45945945945946%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsTAAALEwEAmpwYAAACCUlEQVQoz23SeU/iQBgGcL//Z9i/zK4giIkYjIsHPWkriBqMWkRh7mmhpYXpgYV2Ix7rHm+e5Ene5JeZSWar2MzLaj0R6e8sNhGpK5auWH7unUUSLbPiY7byTQXRsgVEC0YtGEko3lH7tc6TihMdBBoIP/ZRcyQep3FRFPkfOF4qOFJIrNJEQuLbz3bZuO846R1kfTJVSKKQRKXJGYqG3v+wBF8kmEkwk9H62A4adnhN0wHybRJqID4bpy2Qnoxfhl76N54thDzuKrArI0tChowtGXY0YKpDRRvpCrBkcCGNzJNnc+CyDc7f8Gv586BNS4bzvYcbfSTdoFODls1JSac7bV42nbLplAy2I+PtR9f+gvPXmoYzAx1esMNL0uzT9g1RWsPds6cfGtnVWdXgtTbf02lFwqWB+1isiiRN8jzfKopivV5PvIkXTrwF64Hze3R5hzvquKLBqonrFq0brGaxgwtcV1HNdgZplAZh8I6zLCOUIIzoFBh8T2cV06mdj7Zt0hOLOAhnV/yE+kDMI+A8P5CHNP6CV9mKOcz3vUBMuqB5i41boquwYtGDK97s8WOL73d545o3DVy3+UMsknf89nR3Nu1Brc9MY3x0CaUuPFfhvoKrCq4ouKKiPQVXVVI9HZcGzjDP8jiO309+vflqxQKPhZ4zD3jo89B3w/m/4UEo0uXn9/wFaBZ+cFotC40AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"TPU Overview\"\n        title=\"TPU Overview\"\n        src=\"/static/2df9a40c7cc865c061c8256d0299fecf/fcda8/tpu-jito-labs.png\"\n        srcset=\"/static/2df9a40c7cc865c061c8256d0299fecf/12f09/tpu-jito-labs.png 148w,\n/static/2df9a40c7cc865c061c8256d0299fecf/e4a3f/tpu-jito-labs.png 295w,\n/static/2df9a40c7cc865c061c8256d0299fecf/fcda8/tpu-jito-labs.png 590w,\n/static/2df9a40c7cc865c061c8256d0299fecf/efc66/tpu-jito-labs.png 885w,\n/static/2df9a40c7cc865c061c8256d0299fecf/c83ae/tpu-jito-labs.png 1180w,\n/static/2df9a40c7cc865c061c8256d0299fecf/2d912/tpu-jito-labs.png 1772w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span>\n<small style=\"display:block;text-align:center;\">Image Courtesy of Jito Labs</small></p>\n<p>Of these five phases, the Fetch Stage is responsible for receiving transactions. Within the Fetch Stage, validators will categorize incoming transactions according to three ports:</p>\n<ul>\n<li><a href=\"https://github.com/solana-labs/solana/blob/cd6f931223181d5a1d47cba64e857785a175a760/gossip/src/contact_info.rs#L27\">tpu</a> handles regular transactions such as token transfers, NFT mints, and program instructions</li>\n<li><a href=\"https://github.com/solana-labs/solana/blob/cd6f931223181d5a1d47cba64e857785a175a760/gossip/src/contact_info.rs#L31\">tpu_vote</a> focuses exclusively on voting transactions</li>\n<li><a href=\"https://github.com/solana-labs/solana/blob/cd6f931223181d5a1d47cba64e857785a175a760/gossip/src/contact_info.rs#L29\">tpu_forwards</a> forwards unprocessed packets to the next leader if the current leader is unable to process all transactions</li>\n</ul>\n<p>For more information on the TPU, please refer to <a href=\"https://jito-labs.medium.com/solana-validator-101-transaction-processing-90bcdc271143\">this excellent writeup by Jito Labs</a>.</p>\n<h2>How Transactions Get Dropped</h2>\n<p>Throughout a transaction’s journey, there are a few scenarios in which the transaction can be unintentionally dropped from the network.</p>\n<h3>Before a transaction is processed</h3>\n<p>If the network drops a transaction, it will most likely do so before the transaction is processed by a leader. UDP <a href=\"https://en.wikipedia.org/wiki/Packet_loss\">packet loss</a> is the simplest reason why this might occur. During times of intense network load, it’s also possible for validators to become overwhelmed by the sheer number of transactions required for processing. While validators are equipped to forward surplus transactions via <code class=\"language-text\">tpu_forwards</code>, there is a limit to the amount of data that can be <a href=\"https://github.com/solana-labs/solana/blob/master/core/src/banking_stage.rs#L389\">forwarded</a>. Furthermore, each forward is limited to a single hop between validators. That is, transactions received on the <code class=\"language-text\">tpu_forwards</code> port are not forwarded on to other validators.</p>\n<p>There are also two lesser known reasons why a transaction may be dropped before it is processed. The first scenario involves transactions that are submitted via an RPC pool. Occasionally, part of the RPC pool can be sufficiently ahead of the rest of the pool. This can cause issues when nodes within the pool are required to work together. In this example, the transaction’s <a href=\"https://docs.solana.com/developing/programming-model/transactions#recent-blockhash\">recentBlockhash</a> is queried from the advanced part of the pool (Backend A). When the transaction is submitted to the lagging part of the pool (Backend B), the nodes will not recognize the advanced blockhash and will drop the transaction. This can be detected upon transaction submission if developers enable <a href=\"https://docs.solana.com/developing/clients/jsonrpc-api#sendtransaction\">preflight checks</a> on <code class=\"language-text\">sendTransaction</code>.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/3d427e937ae83e53d430094eecc4cdce/bfbcf/dropped-via-rpc-pool.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 53.37837837837838%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAABnklEQVQoz4WTy0ocQRSG+6nyOD6HkGXATXAhZCFkESRMRGQI5kZcGAmTBESNM4i5jEZsTSaTOOPc7GvVOV/oru6ZDphYUFWn+j/996mvqj3+01R1FudrN5RxRZ7mev8yKhMknCDjAUQBxNFMK3o1N5u92yozg0tMr4sZDLHXAVl9mW4ERFwsIrcYFnP2QtaOOrDwImLlvc3V3TPl3rOI+seyQikw3GBY3YLNDYXmhXK3HrP81j3/cKLMr8fUdspcnRlWcPzVpdy2QjAOGQcpiXGiFQgiITWKihDHyfSAvOL8qmeJ4pgcjL4wf7TE8cQvIRQYMoYxqg6BYGcM0wkkQzChklyBCSAaCVxD3d/mztYcjV+tfB0O3Ickhaivea4JIb5SJHEFef5z4dOypduAwyVDZ0s5rlnaj4QfDcubBz/pHUD7seXzQ1fJ+BRai4bOtnL+SmjeT+ntF4bdd8rZU6XfgtM15XJP+b6pnL9U+k3wazBqw8Vrxd9waIIOfFtVevvK7x3l5Ikw/FoYlgjVDVWUjmb+Z2gF9VS88bL9AQJ9T3djs+G+AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Dropped via RPC Pool\"\n        title=\"Dropped via RPC Pool\"\n        src=\"/static/3d427e937ae83e53d430094eecc4cdce/fcda8/dropped-via-rpc-pool.png\"\n        srcset=\"/static/3d427e937ae83e53d430094eecc4cdce/12f09/dropped-via-rpc-pool.png 148w,\n/static/3d427e937ae83e53d430094eecc4cdce/e4a3f/dropped-via-rpc-pool.png 295w,\n/static/3d427e937ae83e53d430094eecc4cdce/fcda8/dropped-via-rpc-pool.png 590w,\n/static/3d427e937ae83e53d430094eecc4cdce/efc66/dropped-via-rpc-pool.png 885w,\n/static/3d427e937ae83e53d430094eecc4cdce/c83ae/dropped-via-rpc-pool.png 1180w,\n/static/3d427e937ae83e53d430094eecc4cdce/bfbcf/dropped-via-rpc-pool.png 4416w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Temporarily network forks can also result in dropped transactions. If a validator is slow to replay its blocks within the Banking Stage, it may end up creating a minority fork. When a client builds a transaction, it’s possible for the transaction to reference a <code class=\"language-text\">recentBlockhash</code> that only exists on the minority fork.  After the transaction is submitted, the cluster can then switch away from its minority fork before the transaction is processed. In this scenario, the transaction is dropped due to the blockhash not being found.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/57f7063803f92b7e729e872abb2365aa/924b7/dropped-minority-fork-pre-process.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 54.72972972972974%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAABpElEQVQoz4WTwW4TMRCG96V4Gt6CKxKXcuEAhx64cEBCQrkUgQQHShFFohQEUpsAVUlplChNILCbpkvwZhN75kNrZ7OJiKilWds7439+e/6JuGSo6mURhJAQF/0PSFT8em9YZ6N5j0E+LBz0R8LD/Zwnh4KZlqDBonAYirOL2ZviXADcbNW4snuVD8kRTKfUuzOu1QwbzxxDU/IMI6roKpVLV/4dHDe4v1MjjmO/zyaOZndCq5dh8xlqLeqcj4+Kj/kOv09hEqufi73pQ3oCbgKnJ9/Ye/WGJElCTlEYxZDGoAZkjM5MdeXOY6Vx2/LjNTTuWNqPlPaWUL9lGXcKlg7Bocj8FoKqw00dyaEy2Id8nssDDutKb0dIm9B/KSQH6q23rRR1uGgGf34O2UA52xbSliAOPt3N+HjTMPocnitalcV6iXSeOt7fyBi34fyL8u66ob/rvO/nW+g9D4kWDMuS+yprJYGi0uUbj47AGpileDbZL0Wscvwgp7GZc/GVsihzuay1ZdH+a2Kh+8LS2rL8OVsCXC/sqktKtoskstodyx3zF5Z1Tce5UlzxAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Dropped due to Minority Fork (Before Processed)\"\n        title=\"Dropped due to Minority Fork (Before Processed)\"\n        src=\"/static/57f7063803f92b7e729e872abb2365aa/fcda8/dropped-minority-fork-pre-process.png\"\n        srcset=\"/static/57f7063803f92b7e729e872abb2365aa/12f09/dropped-minority-fork-pre-process.png 148w,\n/static/57f7063803f92b7e729e872abb2365aa/e4a3f/dropped-minority-fork-pre-process.png 295w,\n/static/57f7063803f92b7e729e872abb2365aa/fcda8/dropped-minority-fork-pre-process.png 590w,\n/static/57f7063803f92b7e729e872abb2365aa/efc66/dropped-minority-fork-pre-process.png 885w,\n/static/57f7063803f92b7e729e872abb2365aa/c83ae/dropped-minority-fork-pre-process.png 1180w,\n/static/57f7063803f92b7e729e872abb2365aa/924b7/dropped-minority-fork-pre-process.png 4154w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h3>After a transaction is processed and before it is finalized</h3>\n<p>In the event a transaction references a <code class=\"language-text\">recentBlockhash</code> from a minority fork, it’s still possible for the transaction to be processed. In this case, however, it would be processed by the leader on the minority fork. When this leader attempts to share its processed transactions with the rest of the network, it would fail to reach consensus with the majority of validators that do not recognize the minority fork. At this time, the transaction would be dropped before it could be finalized.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/250c822278d34b6ecfafac937ebb6da0/bbb71/dropped-minority-fork-post-process.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 53.37837837837838%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAABYlAAAWJQFJUiTwAAABoklEQVQoz4WSy27TUBCG/Wy8C2+BWCEECzYgdUkrVuy4NMKrgqo2ILUqSauUFBzTBhoncQqu69x8OfMhn5w4dlqJkcbj8Rn/859/xuIOE5EiLh2kXFH6vqrPzfofoDJg8xRe1WM29xNGEZWG5X+sNaRboEsLxgmPt6c82o65DECyuOBcYZi/V33VdRQHPGhv8HF4QDZLGcfCLAXXdanX9/F9/xZTSyfKaKIjZErpQyf6zb3d+2ydvzfKZTq2Wi1s26bb7epcZcpcTu7ScDmAlOuex1v7He3vZ/okTReAnY5LrVZjOBiuDQqsq6Yw/CyEjuB9UoQODOpCeDJnPOhx+vWIft9bMDHM86senzSJJjdcOwrnww3jX4ah+1rxbSOjtyM0n6Z4O9B6kXLxRiEqQwUhklZXBqUvoO2nPWXv4R/8L2Yo0wFMLmH+F6KLPIruFud5F46fJ3i7C2YqWQD39xSNZ3MmHlw1FI0nCcFpsTZC1Vc6TvrC2VaCf2gAMzP9I0X7ZcJsBGEHfmwK0bmU1kaZlVmP+kExwbL4FCu2qs81/AebxUy28IqbggAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Dropped due to Minority Fork (After Processed)\"\n        title=\"Dropped due to Minority Fork (After Processed)\"\n        src=\"/static/250c822278d34b6ecfafac937ebb6da0/fcda8/dropped-minority-fork-post-process.png\"\n        srcset=\"/static/250c822278d34b6ecfafac937ebb6da0/12f09/dropped-minority-fork-post-process.png 148w,\n/static/250c822278d34b6ecfafac937ebb6da0/e4a3f/dropped-minority-fork-post-process.png 295w,\n/static/250c822278d34b6ecfafac937ebb6da0/fcda8/dropped-minority-fork-post-process.png 590w,\n/static/250c822278d34b6ecfafac937ebb6da0/efc66/dropped-minority-fork-post-process.png 885w,\n/static/250c822278d34b6ecfafac937ebb6da0/c83ae/dropped-minority-fork-post-process.png 1180w,\n/static/250c822278d34b6ecfafac937ebb6da0/bbb71/dropped-minority-fork-post-process.png 4580w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<h2>Handling Dropped Transactions</h2>\n<p>While RPC nodes will attempt to rebroadcast transactions, the algorithm they employ is generic and often ill-suited for the needs of specific applications. To prepare for times of network congestion, application developers should customize their own rebroadcasting logic.</p>\n<h3>An In-Depth Look at sendTransaction</h3>\n<p>When it comes to submitting transactions, the <code class=\"language-text\">sendTransaction</code> RPC method is the primary tool available to developers. <code class=\"language-text\">sendTransaction</code> is only responsible for relaying a transaction from a client to an RPC node. If the node receives the transaction, <code class=\"language-text\">sendTransaction</code> will return the transaction id that can be used to track the transaction. A successful response does not indicate whether the transaction will be processed or finalized by the cluster.</p>\n<h4>Request Parameters</h4>\n<ul>\n<li><code class=\"language-text\">transaction</code>: <code class=\"language-text\">string</code> - fully-signed Transaction, as encoded string</li>\n<li>(optional) <code class=\"language-text\">configuration object</code>: <code class=\"language-text\">object</code>\n<ul>\n<li><code class=\"language-text\">skipPreflight</code>: <code class=\"language-text\">boolean</code> - if true, skip the preflight transaction checks (default: false)</li>\n<li>(optional) <code class=\"language-text\">preflightCommitment</code>: <code class=\"language-text\">string</code> - <a href=\"https://docs.solana.com/developing/clients/jsonrpc-api#configuring-state-commitment\">Commitment</a> level to use for preflight simulations against the bank slot (default: “finalized”).</li>\n<li>(optional) <code class=\"language-text\">encoding</code>: <code class=\"language-text\">string</code> - Encoding used for the transaction data. Either “base58” (slow), or “base64”. (default: “base58”).</li>\n<li>(optional) <code class=\"language-text\">maxRetries</code>: <code class=\"language-text\">usize</code> - Maximum number of times for the RPC node to retry sending the transaction to the leader. If this parameter is not provided, the RPC node will retry the transaction until it is finalized or until the blockhash expires.</li>\n</ul>\n</li>\n</ul>\n<h4>Response</h4>\n<ul>\n<li><code class=\"language-text\">transaction id</code>: <code class=\"language-text\">string</code> - First transaction signature embedded in the transaction, as base-58 encoded string. This transaction id can be used with <a href=\"https://docs.solana.com/developing/clients/jsonrpc-api#getsignaturestatuses\">getSignatureStatuses</a> to poll for status updates.</li>\n</ul>\n<h2>Customizing Rebroadcast Logic</h2>\n<p>In order to develop their own rebroadcasting logic, developers should take advantage of <code class=\"language-text\">sendTransaction</code>’s <code class=\"language-text\">maxRetries</code> parameter. If provided, <code class=\"language-text\">maxRetries</code> will override an RPC node’s default retry logic, allowing developers to manually control the retry process <a href=\"https://github.com/solana-labs/solana/blob/master/validator/src/main.rs#L1316-L1332\">within reasonable bounds</a>.</p>\n<p>A common pattern for manually retrying transactions involves temporarily storing the <code class=\"language-text\">lastValidBlockHeight</code> that comes from <a href=\"https://docs.solana.com/developing/clients/jsonrpc-api#getlatestblockhash\">getLatestBlockhash</a>. Once stashed, an application can then <a href=\"https://docs.solana.com/developing/clients/jsonrpc-api#getblockheight\">poll the cluster’s blockheight</a> and manually retry the transaction at an appropriate interval. In times of network congestion, it’s advantageous to set <code class=\"language-text\">maxRetries</code> to 0 and manually rebroadcast via a custom algorithm. While some applications may employ an <a href=\"https://en.wikipedia.org/wiki/Exponential_backoff\">exponential backoff</a> algorithm, others such as <a href=\"https://www.mango.markets/\">Mango</a> opt to <a href=\"https://github.com/blockworks-foundation/mango-ui/blob/b6abfc6c13b71fc17ebbe766f50b8215fa1ec54f/src/utils/send.tsx#L713\">continuously resubmit</a> transactions at a constant interval until some timeout has occurred.</p>\n<deckgo-highlight-code language=\"typescript\"  >\n          <code slot=\"code\">(async () =&gt; {\nwhile (!done &amp;&amp; getUnixTs() - startTime &lt; timeout) {\n    connection.sendRawTransaction(rawTransaction, {\n        skipPreflight: true,\n    });\n    await sleep(300);\n}\n})();</code>\n        </deckgo-highlight-code>\n<p>When polling via <code class=\"language-text\">getLatestBlockhash</code>, applications should specify their intended <a href=\"https://docs.solana.com/developing/clients/jsonrpc-api#configuring-state-commitment\">commitment</a> level. By setting its commitment to <code class=\"language-text\">confirmed</code> (voted on) or <code class=\"language-text\">finalized</code> (~30 blocks after <code class=\"language-text\">confirmed</code>), an application can avoid polling a blockhash from a minority fork.</p>\n<p>If an application has access to RPC nodes behind a load balancer, it can also choose to divide its workload amongst specific nodes. RPC nodes that serve data-intensive requests such as <a href=\"https://solanacookbook.com/guides/get-program-accounts.html#get-program-accounts\">getProgramAccounts</a> may be prone to falling behind and can be ill-suited for also forwarding transactions. For applications that handle time-sensitive transactions, it may be prudent to have dedicated nodes that only handle <code class=\"language-text\">sendTransaction</code>.</p>\n<h3>The Cost of Skipping Preflight</h3>\n<p>By default, <code class=\"language-text\">sendTransaction</code> will perform three preflight checks prior to submitting a transaction. Specifically, <code class=\"language-text\">sendTransaction</code> will:</p>\n<ul>\n<li>Verify that all signatures are valid</li>\n<li>Check that the referenced blockhash is within the last 150 blocks</li>\n<li>Simulate the transaction against the bank slot specified by the <code class=\"language-text\">preflightCommitment</code></li>\n</ul>\n<p>In the event that any of these three preflight checks fail, <code class=\"language-text\">sendTransaction</code> will raise an error prior to submitting the transaction. Preflight checks can often be the difference between losing a transaction and allowing a client to gracefully handle an error. To ensure that these common errors are accounted for, it is recommended that developers keep <code class=\"language-text\">skipPreflight</code> set to <code class=\"language-text\">false</code>.</p>\n<h3>When to Re-Sign Transactions</h3>\n<p>Despite all attempts to rebroadcast, there may be times in which a client is required to re-sign a transaction. Before re-signing any transaction, it is <strong>very important</strong> to ensure that the initial transaction’s blockhash has expired. If the initial blockhash is still valid, it is possible for both transactions to be accepted by the network. To an end-user, this would appear as if they unintentionally sent the same transaction twice.</p>\n<p>In Solana, a dropped transaction can be safely discarded once the blockhash it references is older than the <code class=\"language-text\">lastValidBlock</code> received from <code class=\"language-text\">getRecentBlockhash</code>. Developers can conveniently check this for a given blockhash via <a href=\"https://docs.solana.com/developing/clients/jsonrpc-api#isblockhashvalid\">isBlockhashValid</a>. Once a blockhash is invalidated, clients may re-sign with a newly-queried blockhash.</p>\n<h2>Acknowledgements</h2>\n<p>Many thanks to Trent Nelson, <a href=\"https://twitter.com/jacobvcreech\">Jacob Creech</a>, White Tiger, Le Yafo, <a href=\"https://twitter.com/buffalu__\">Buffalu</a>, and <a href=\"https://twitter.com/jito_labs\">Jito Labs</a> for their review and feedback.</p>","timeToRead":11,"frontmatter":{"title":"Resending Dropped Transactions","date":"January 15, 2022","description":"A technical overview of how Solana processes transactions, along with tips on how developers can handle dropped transactions.","featuredImage":{"childImageSharp":{"fluid":{"base64":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAFwAAAwEAAAAAAAAAAAAAAAAAAAIDBf/EABYBAQEBAAAAAAAAAAAAAAAAAAMBAv/aAAwDAQACEAMQAAABemVcEQc1P//EABsQAAEEAwAAAAAAAAAAAAAAAAEAAgMREBIT/9oACAEBAAEFAmSlOlK7PsGlscf/xAAWEQEBAQAAAAAAAAAAAAAAAAAAARH/2gAIAQMBAT8BjH//xAAVEQEBAAAAAAAAAAAAAAAAAAAAEf/aAAgBAgEBPwFX/8QAGRAAAgMBAAAAAAAAAAAAAAAAAAEQETJh/9oACAEBAAY/AsmUOlHY/8QAGhAAAwEBAQEAAAAAAAAAAAAAAAERMSGBkf/aAAgBAQABPyGJKfpDPSjRB0ZhiZHXHKSb0//aAAwDAQACAAMAAAAQCN//xAAXEQEBAQEAAAAAAAAAAAAAAAARACFR/9oACAEDAQE/EAbPt//EABYRAQEBAAAAAAAAAAAAAAAAAAEQEf/aAAgBAgEBPxBHY//EABoQAQADAQEBAAAAAAAAAAAAAAEAESExUZH/2gAIAQEAAT8QSxh6kAxLy3EvIjbkykApzsdbANj7UKqVvUn/2Q==","aspectRatio":1.5,"src":"/static/3233773edb8b35c6f70f93819765bdc1/74fd5/oregon-trail.jpg","srcSet":"/static/3233773edb8b35c6f70f93819765bdc1/e3903/oregon-trail.jpg 480w,\n/static/3233773edb8b35c6f70f93819765bdc1/b31d1/oregon-trail.jpg 960w,\n/static/3233773edb8b35c6f70f93819765bdc1/74fd5/oregon-trail.jpg 1920w,\n/static/3233773edb8b35c6f70f93819765bdc1/c1679/oregon-trail.jpg 2880w,\n/static/3233773edb8b35c6f70f93819765bdc1/c066c/oregon-trail.jpg 3757w","srcWebp":"/static/3233773edb8b35c6f70f93819765bdc1/6833b/oregon-trail.webp","srcSetWebp":"/static/3233773edb8b35c6f70f93819765bdc1/61162/oregon-trail.webp 480w,\n/static/3233773edb8b35c6f70f93819765bdc1/596e5/oregon-trail.webp 960w,\n/static/3233773edb8b35c6f70f93819765bdc1/6833b/oregon-trail.webp 1920w,\n/static/3233773edb8b35c6f70f93819765bdc1/5c931/oregon-trail.webp 2880w,\n/static/3233773edb8b35c6f70f93819765bdc1/07a72/oregon-trail.webp 3757w","sizes":"(max-width: 1920px) 100vw, 1920px"}}},"thumbnail":{"childImageSharp":{"gatsbyImageData":{"layout":"fixed","backgroundColor":"#584818","images":{"fallback":{"src":"/static/3233773edb8b35c6f70f93819765bdc1/d24c0/oregon-trail.jpg","srcSet":"/static/3233773edb8b35c6f70f93819765bdc1/d24c0/oregon-trail.jpg 3757w","sizes":"3757px"},"sources":[{"srcSet":"/static/3233773edb8b35c6f70f93819765bdc1/6f01a/oregon-trail.webp 3757w","type":"image/webp","sizes":"3757px"}]},"width":3757,"height":2501}}}}}},"pageContext":{"slug":"/resending-dropped-transactions-on-solana/","previous":{"fields":{"slug":"/how-to-create-a-token-on-solana/"},"frontmatter":{"title":"Creating Tokens on Solana"}},"next":{"fields":{"slug":"/the-complete-guide-to-phantom-deeplinks/"},"frontmatter":{"title":"The Complete Guide to Phantom Deeplinks"}}}},"staticQueryHashes":["3193446067","719542093"]}